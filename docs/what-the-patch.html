<!doctype html>

<html lang="en">

<!--
  Apply head only for dev environment, this is required for jekyll to
  insert livereload scripts
-->

  <head>



  <meta charset="utf-8">


<title>What the patch?! - Felix Wolff</title>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- Define a description for better SEO result -->
<meta name="description" content="Comparing patching mechanisms in kustomize">

<!-- Cheome Web App theme color -->
<meta name="theme-color" content="#ff00b4">

<!-- Feed URL -->
<link rel="alternate" href="/feed.xml" type="application/atom+xml">

<!-- Site icons -->
<link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.png" type="image/png"><link rel="icon" href="/favicon.svg?assets-inline-assets-keep" sizes="any" type="image/svg+xml"><link rel="mask-icon" href="/mask-icon.svg" color="#ff00b4">

<!-- Chrome Web App manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Main CSS -->
<link rel="stylesheet" href="/assets/themes/curtana/css/app.css?assets-inline">

<!-- Canonical links, avoid duplicate content problems -->
<link rel="canonical" href="http://0.0.0.0:4321/what-the-patch.html">

<!-- DNS prefetching for static files -->


<!-- Head hooks -->



  </head>

<!-- Open Graph and Twitter Cards support -->
<meta property="og:type" content="article">
<meta property="og:site_name" content="Felix Wolff">
<meta property="og:title" content="What the patch?!">
<meta property="og:url" content="http://0.0.0.0:4321/what-the-patch.html">
<meta property="og:description" content="Comparing patching mechanisms in kustomize">
<meta property="og:image" content="http://0.0.0.0:4321/logo.png">

<meta name="twitter:card" content="summary_large_image">


  <meta name="twitter:site" content="@sparanoid">





  <meta property="article:published_time" content="2021-06-16T00:00:00+02:00">
  <meta property="article:modified_time" content="2022-10-22T15:52:11+02:00">
  <meta name="twitter:label1" value="Words">
  <meta name="twitter:data1" value="417 words">
  <meta name="twitter:label2" value="Reading time">
  <meta name="twitter:data2" value="2 mins">

<!-- Post specified styles -->
<style data-assets-inline>
  :root {
    

    

    

    
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --text-color-l: 95%;
      --bg-color-l: 14%;
      --bg-color-s: 2%;
      --code-color-l: calc(var(--link-color-l) * 1.3);
    }
  }
  

  body {
    
  }

  
  
    
</style>
<!-- Main navigation with current page / categoriy highlighted -->
<nav class="navigation">
  <ul>
    <li >
        <a href="/">Felix Wolff</a>
      </li>
    <li class=current>
        <a href="/blog/">Blog</a>
      </li>
    <li >
        <a href="/cv/">CV</a>
      </li>
    <li >
        <a href="/imprint/">Imprint</a>
      </li>
    
  </ul>
</nav>
<!-- Main content wrap -->
<main class="content " role=main>
  <!-- Post-wide custom CSS -->


<!-- Article wrapper, limit width -->
<article lang="en">

  <!-- Post title -->
  <header style="     ">

    <h1 class="" title="What the patch?!" data-title="What the patch?!">
      What the patch?!<span class="dot dot--post"> </span>
    </h1>

    
      <small>
        By <span rel="author">Felix Wolff</span>
        on <time datetime="2021-06-16T00:00:00+02:00">Jun 16, 2021</time>
      </small>
    

    
      <small>Comparing patching mechanisms in kustomize</small>
    

  </header>

  <!-- Post content -->
  <div class="post-content">
    <p>At work I deal with Kubernetes and kustomize on a daily basis.
Today I have pulled my hair about how I could patch a value in a job that was included in the base kustomization.
I knew that there were several ways to do it, and I realized that I could not tell the difference between <code class="language-plaintext highlighter-rouge">patches</code>, <code class="language-plaintext highlighter-rouge">patchesJson6902</code> and <code class="language-plaintext highlighter-rouge">patchesStrategicMerge</code>.</p>

<p>It turns out that the three directives can be regarded as variations of the same patching mechanism.
They differ in terms of customizability, and hence the number of things you can do (and break) with them.
To me, the hierarchy feels as follows, starting with the least versatile and powerful directive:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">patchesStrategicMerge</code></li>
  <li><code class="language-plaintext highlighter-rouge">patchesJson6902</code></li>
  <li><code class="language-plaintext highlighter-rouge">patches</code></li>
</ol>

<hr />

<p>Why is <code class="language-plaintext highlighter-rouge">patchesStrategicMerge</code> the least powerful and versatile?
Because itâ€™s simple! Try to use it, the reviewers will be thankful.</p>

<p>Check the <a href="https://github.com/kubernetes-sigs/cli-experimental/blob/e8661e62fbff9bb41703e663c5d6f9730f121a16/site/content/en/references/kustomize/kustomization/patchesStrategicMerge/_index.md">documentation here</a>.
It tells us that <em>each patch should be either a relative file path or an inline content resolving to a partial or complete resource definition</em>. 
That means these patches do what we are used to from git, for example. 
They patch a single thing, so are ideal for correcting environment variables, names, paths, and the likes.</p>

<hr />

<p>It turns out that the <code class="language-plaintext highlighter-rouge">patchJson6902</code> directive is an older keyword, that must also target a specific resource,
but can deliver more complex operations on the patch target.
These operations are specified in the JSON6902 format, hence the name.
The actual patch is delivered via JSON (but can also be YAML), for instance like below.
More examples can be found in the <a href="https://github.com/kubernetes-sigs/cli-experimental/blob/e8661e62fbff9bb41703e663c5d6f9730f121a16/site/content/en/references/kustomize/kustomization/patchesjson6902/_index.md">documentation</a>.</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"op"</span><span class="p">:</span><span class="w"> </span><span class="s2">"remove"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/spec/template/spec/containers/0/env/0/valueFrom"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"op"</span><span class="p">:</span><span class="w"> </span><span class="s2">"add"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/spec/template/spec/containers/0/env/0/value"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SOMEVALUE"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre></figure>

<p>Finally, the <code class="language-plaintext highlighter-rouge">patches</code> directive is the new shiny swiss army knife.
It needs a target, too, but the target can be a <em>regex</em>.
The patch instructions are delivered in the JSON6902 format introduced above.
In short, this directive allows you to patch multiple targets using complex operations all in a single directive.
Truly powerful, and truly tricky to review.
You can find the <a href="https://github.com/kubernetes-sigs/cli-experimental/blob/e8661e62fbff9bb41703e663c5d6f9730f121a16/site/content/en/references/kustomize/kustomization/patches/_index.md">whole documention for this directive here</a>.</p>

<h3 id="sources">Sources</h3>
<ul>
  <li>https://github.com/kubernetes-sigs/kustomize/issues/2705</li>
  <li>https://stackoverflow.com/questions/63604579/what-is-the-difference-between-patches-vs-patchesjson6902-in-kustomize</li>
</ul>


    
    

    
  </div>

</article>

</main>
<!-- Footer section -->

  <footer class="footer">
    <ul>
      <li><a href="/">Felix Wolff</a></li>

      
        <li>
          <a href="https://sparanoid.com/lab/amsf/" title="Almace Scaffolding with theme Curtana">AMSF</a>
        </li>
      

      <li>
          <a href="/feed.xml">feed</a>
        </li>
      
    </ul>
  </footer>


<!-- Theme scripts -->
<script src="/assets/themes/curtana/js/app.js?assets-inline"></script>

<!-- User scripts -->
<script src="/assets/js/user.js?assets-inline"></script>

<!-- Lightense Images -->


<!-- Service Worker  -->


<!-- Google Analytics -->


<!-- Foot hooks -->


<!-- Finale -->
</html>
