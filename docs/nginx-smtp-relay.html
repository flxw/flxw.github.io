<!doctype html>

<html lang="en">

<!--
  Apply head only for dev environment, this is required for jekyll to
  insert livereload scripts
-->

  <head>



  <meta charset="utf-8">


<title>Making nginx act as an SMTP relay - Felix Wolff</title>

<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<!-- Define a description for better SEO result -->
<meta name="description" content="To test an application out in the wild I had to host it on my server. As it receives and processes email via SMTP, it needed access to port 25. I did not bother learning and installing some tool that...">

<!-- Cheome Web App theme color -->
<meta name="theme-color" content="#ff00b4">

<!-- Feed URL -->
<link rel="alternate" href="/feed.xml" type="application/atom+xml">

<!-- Site icons -->
<link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="icon" href="/favicon.png" type="image/png"><link rel="icon" href="/favicon.svg?assets-inline-assets-keep" sizes="any" type="image/svg+xml"><link rel="mask-icon" href="/mask-icon.svg" color="#ff00b4">

<!-- Chrome Web App manifest -->
<link rel="manifest" href="/manifest.json">

<!-- Main CSS -->
<link rel="stylesheet" href="/assets/themes/curtana/css/app.css?assets-inline">

<!-- Canonical links, avoid duplicate content problems -->
<link rel="canonical" href="http://0.0.0.0:4321/nginx-smtp-relay.html">

<!-- DNS prefetching for static files -->


<!-- Head hooks -->



  </head>

<!-- Open Graph and Twitter Cards support -->
<meta property="og:type" content="article">
<meta property="og:site_name" content="Felix Wolff">
<meta property="og:title" content="Making nginx act as an SMTP relay">
<meta property="og:url" content="http://0.0.0.0:4321/nginx-smtp-relay.html">
<meta property="og:description" content="To test an application out in the wild I had to host it on my server. As it receives and processes email via SMTP, it needed access to port 25. I did not bother learning and installing some tool that...">
<meta property="og:image" content="http://0.0.0.0:4321/logo.png">

<meta name="twitter:card" content="summary_large_image">


  <meta name="twitter:site" content="@sparanoid">





  <meta property="article:published_time" content="2014-09-04T00:00:00+02:00">
  <meta property="article:modified_time" content="2022-10-22T15:05:10+02:00">
  <meta name="twitter:label1" value="Words">
  <meta name="twitter:data1" value="300 words">
  <meta name="twitter:label2" value="Reading time">
  <meta name="twitter:data2" value="1 min">

<!-- Post specified styles -->
<style data-assets-inline>
  :root {
    

    

    

    
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --text-color-l: 95%;
      --bg-color-l: 14%;
      --bg-color-s: 2%;
      --code-color-l: calc(var(--link-color-l) * 1.3);
    }
  }
  

  body {
    
  }

  
  
    
</style>
<!-- Main navigation with current page / categoriy highlighted -->
<nav class="navigation">
  <ul>
    <li >
        <a href="/">Felix Wolff</a>
      </li>
    <li class=current>
        <a href="/blog/">Blog</a>
      </li>
    <li >
        <a href="/cv/">CV</a>
      </li>
    <li >
        <a href="/imprint/">Imprint</a>
      </li>
    
  </ul>
</nav>
<!-- Main content wrap -->
<main class="content " role=main>
  <!-- Post-wide custom CSS -->


<!-- Article wrapper, limit width -->
<article lang="en">

  <!-- Post title -->
  <header style="     ">

    <h1 class="" title="Making nginx act as an SMTP relay" data-title="Making nginx act as an SMTP relay">
      Making nginx act as an SMTP relay<span class="dot dot--post"> </span>
    </h1>

    
      <small>
        By <span rel="author">Felix Wolff</span>
        on <time datetime="2014-09-04T00:00:00+02:00">Sep 4, 2014</time>
      </small>
    

    

  </header>

  <!-- Post content -->
  <div class="post-content">
    <p>To test an application out in the wild I had to host it on my server.
As it receives and processes email via SMTP, it needed access to port 25.</p>

<p>I did not bother learning and installing some tool that makes sub-1000 ports
available to applications without superuser rights, and thus I made use
of nginxâ€™ capabilities.</p>

<p>Inside the main <em>nginx.conf</em>, I added a section for email:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mail {
    # See sample authentication script at:
    # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript

    # auth_http localhost/auth.php;
    # pop3_capabilities "TOP" "USER";
    # imap_capabilities "IMAP4rev1" "UIDPLUS";

    auth_http http://127.0.0.1/mail/auth;
    xclient off;
    proxy_pass_error_message on;

    server {
        listen     25;
        protocol   smtp;
        timeout    5s;
        proxy      on;
        xclient    off;
        smtp_auth  none;
        so_keepalive on;
    }
}
</code></pre></div></div>

<p>Each of the configurations for my sites are loaded as individual modules, like it is the case with Apache.
Inside the configuration that handles the default behaviour for the web server, the following route was established.
It tells the mail client where to find the SMTP server. This can also be equipped with more logic to make it act as a load balancer.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    location = /mail/auth {
            set $reply ERROR;

            if ($http_auth_smtp_to ~ flxw.de) {
                set $reply OK;
            }

            add_header Auth-Status OK;
            add_header Auth-Server 127.0.0.1;
            add_header Auth-Port 2525;
            add_header Auth-Wait 1;
            return 204;
        }
</code></pre></div></div>

<p>And finally there is the configuration file for the web app itself.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>upstream app.myapp.de {
    server 127.0.0.1:8080;
}

# the nginx server instance
server {
    listen 0.0.0.0:80;
    server_name myapp.flxw.de;
    access_log /var/log/nginx/myapp.mydomain.de.log;

    auth_basic  "Restricted";
    auth_basic_user_file /etc/nginx/htpasswd;

    # pass the request to the node.js server with the correct headers and much more can be added, see nginx config options
    location / {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;

      proxy_pass http://myapp.mydomain.de/;
      proxy_redirect off;
    }
 }
</code></pre></div></div>


    
    

    
  </div>

</article>

</main>
<!-- Footer section -->

  <footer class="footer">
    <ul>
      <li><a href="/">Felix Wolff</a></li>

      
        <li>
          <a href="https://sparanoid.com/lab/amsf/" title="Almace Scaffolding with theme Curtana">AMSF</a>
        </li>
      

      <li>
          <a href="/feed.xml">feed</a>
        </li>
      
    </ul>
  </footer>


<!-- Theme scripts -->
<script src="/assets/themes/curtana/js/app.js?assets-inline"></script>

<!-- User scripts -->
<script src="/assets/js/user.js?assets-inline"></script>

<!-- Lightense Images -->


<!-- Service Worker  -->


<!-- Google Analytics -->


<!-- Foot hooks -->


<!-- Finale -->
</html>
